axis.text.y = element_blank(),
axis.ticks = element_blank())
Pollutant_distribution
#Create a histogram showing the prevalence of each decile in the area
City_histogram <- ggplot(data=stitched_shapefile)+
aes(x=IMD,fill=IMD )+
geom_bar()+
labs(x="IMD decile",
title=paste0(custom_name," IMD histogram"))+
scale_x_discrete(
breaks=c(1:10),
expand = expansion(mult=0,add=0))+
scale_fill_viridis_d()+
guides(fill=guide_legend(ncol=2, byrow=FALSE))
City_histogram
#aoufbihwevbfiywaegrbvibrvkljbverkaljb
#Create a graph showing the relationship between NOx and decile within the chosen area
City_profile <- ggplot(data=filtered_data,
aes(x="IMD",
y="Total"))+
coord_cartesian(xlim = c(1, 10),
ylim= c(0,50))+
scale_x_discrete(
breaks=c(1:10),
expand = expansion(mult=0,add=0))+
scale_y_discrete(
expand = expansion(mult=0,add=0))+
labs(x="IMD decile",
y=paste0(pollutant," emissions"),
title=paste0(custom_name," NOx emission"))+
#Plot the line of best fit for the mean
geom_smooth(method="lm",
formula=y~x,
se=TRUE,
show.legend=FALSE,
aes(color='Mean'))+
#Plot a line passing through the mean at each decile
#Plot the line of best fit for the median
geom_quantile(quantiles=0.5,
aes(color='Median'),
size =1)+
#Plot a line passing through the median at each decile
geom_smooth(data=read.csv(prawn_path)
, aes(
x=IMD,
y=Total,
color='UK Average'),
method="lm",
formula=y~x,
se=FALSE,
show.legend = FALSE)+
#An extra line showing the UK average for comparison purposes
geom_line(data=read.csv(prawn_path),stat="summary" , aes(
x=IMD,
y=Total,colour='UK Average'),
show.legend = FALSE
)+
scale_colour_manual(name="Line type",
breaks = c('Mean','Median','UK Average'),
values=c('Mean'='blue','Median'='red','UK Average'='black'))
City_profile
City_profile <- ggplot(data=filtered_data,
aes(x="IMD",
y="Total"))+geom_line()
City_profile
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+geom_line()
City_profile
#aoufbihwevbfiywaegrbvibrvkljbverkaljb
#Create a graph showing the relationship between NOx and decile within the chosen area
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+
coord_cartesian(xlim = c(1, 10),
ylim= c(0,50))+
scale_x_discrete(
breaks=c(1:10),
expand = expansion(mult=0,add=0))+
scale_y_discrete(
expand = expansion(mult=0,add=0))+
labs(x="IMD decile",
y=paste0(pollutant," emissions"),
title=paste0(custom_name," NOx emission"))+
#Plot the line of best fit for the mean
geom_smooth(method="lm",
formula=y~x,
se=TRUE,
show.legend=FALSE,
aes(color='Mean'))+
#Plot a line passing through the mean at each decile
#Plot the line of best fit for the median
geom_quantile(quantiles=0.5,
aes(color='Median'),
size =1)+
#Plot a line passing through the median at each decile
geom_smooth(data=read.csv(prawn_path)
, aes(
x=IMD,
y=Total,
color='UK Average'),
method="lm",
formula=y~x,
se=FALSE,
show.legend = FALSE)+
#An extra line showing the UK average for comparison purposes
geom_line(data=read.csv(prawn_path),stat="summary" , aes(
x=IMD,
y=Total,colour='UK Average'),
show.legend = FALSE
)+
scale_colour_manual(name="Line type",
breaks = c('Mean','Median','UK Average'),
values=c('Mean'='blue','Median'='red','UK Average'='black'))
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+geom_line()
#aoufbihwevbfiywaegrbvibrvkljbverkaljb
#Create a graph showing the relationship between NOx and decile within the chosen area
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+
coord_cartesian(xlim = c(1, 10),
ylim= c(0,50))+
scale_x_discrete(
breaks=c(1:10),
expand = expansion(mult=0,add=0))+
scale_y_discrete(
expand = expansion(mult=0,add=0))+
labs(x="IMD decile",
y=paste0(pollutant," emissions"),
title=paste0(custom_name," NOx emission"))+
#Plot the line of best fit for the mean
geom_smooth(method="lm",
formula=y~x,
se=TRUE,
show.legend=FALSE,
aes(color='Mean'))+
#Plot a line passing through the mean at each decile
#Plot the line of best fit for the median
geom_quantile(quantiles=0.5,
aes(color='Median'),
size =1)+
#Plot a line passing through the median at each decile
geom_smooth(data=read.csv(prawn_path)
, aes(
x=IMD,
y=Total,
color='UK Average'),
method="lm",
formula=y~x,
se=FALSE,
show.legend = FALSE)+
#An extra line showing the UK average for comparison purposes
geom_line(data=read.csv(prawn_path),stat="summary" , aes(
x=IMD,
y=Total,colour='UK Average'),
show.legend = FALSE
)+
scale_colour_manual(name="Line type",
breaks = c('Mean','Median','UK Average'),
values=c('Mean'='blue','Median'='red','UK Average'='black'))
City_profile
filtered_data %>% group_by(IMD)
filtered_data <- filtered_data %>% group_by(IMD)
#aoufbihwevbfiywaegrbvibrvkljbverkaljb
#Create a graph showing the relationship between NOx and decile within the chosen area
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+
coord_cartesian(xlim = c(1, 10),
ylim= c(0,50))+
scale_x_discrete(
breaks=c(1:10),
expand = expansion(mult=0,add=0))+
scale_y_discrete(
expand = expansion(mult=0,add=0))+
labs(x="IMD decile",
y=paste0(pollutant," emissions"),
title=paste0(custom_name," NOx emission"))+
#Plot the line of best fit for the mean
geom_smooth(method="lm",
formula=y~x,
se=TRUE,
show.legend=FALSE,
aes(color='Mean'))+
#Plot a line passing through the mean at each decile
#Plot the line of best fit for the median
geom_quantile(quantiles=0.5,
aes(color='Median'),
size =1)+
#Plot a line passing through the median at each decile
geom_smooth(data=read.csv(prawn_path)
, aes(
x=IMD,
y=Total,
color='UK Average'),
method="lm",
formula=y~x,
se=FALSE,
show.legend = FALSE)+
#An extra line showing the UK average for comparison purposes
geom_line(data=read.csv(prawn_path),stat="summary" , aes(
x=IMD,
y=Total,colour='UK Average'),
show.legend = FALSE
)+
scale_colour_manual(name="Line type",
breaks = c('Mean','Median','UK Average'),
values=c('Mean'='blue','Median'='red','UK Average'='black'))
City_profile
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+
geom_smooth(method="lm",
formula=y~x,
se=TRUE,
show.legend=FALSE,
aes(color='Mean'))
City_profile
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+
geom_smooth(method="lm",
formula=y~x,
aes(color='Mean'))
City_profile
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+
geom_smooth(method="lm",
formula=y~x,
aes(color='Mean'))
City_profile
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+
geom_smooth(
formula=y~x,
aes(color='Mean'))
City_profile
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+
geom_smooth(
formula=y~x,
)
City_profile
#aoufbihwevbfiywaegrbvibrvkljbverkaljb
#Create a graph showing the relationship between NOx and decile within the chosen area
City_profile <- ggplot(data=filtered_data)+
aes(x=IMD,
y=Total)+
coord_cartesian(xlim = c(1, 10),
ylim= c(0,50))+
scale_x_discrete(
breaks=c(1:10),
expand = expansion(mult=0,add=0))+
scale_y_discrete(
expand = expansion(mult=0,add=0))+
labs(x="IMD decile",
y=paste0(pollutant," emissions"),
title=paste0(custom_name," NOx emission"))+
#Plot the line of best fit for the mean
geom_smooth(method="lm",
formula=y~x,
se=TRUE,
show.legend=FALSE,
aes(color='Mean'))+
#Plot a line passing through the mean at each decile
#Plot the line of best fit for the median
geom_quantile(quantiles=0.5,
aes(color='Median'),
size =1)+
#Plot a line passing through the median at each decile
geom_smooth(data=read.csv(prawn_path)
, aes(
x=IMD,
y=Total,
color='UK Average'),
method="lm",
formula=y~x,
se=FALSE,
show.legend = FALSE)+
#An extra line showing the UK average for comparison purposes
geom_line(data=read.csv(prawn_path),stat="summary" , aes(
x=IMD,
y=Total,colour='UK Average'),
show.legend = FALSE
)+
scale_colour_manual(name="Line type",
breaks = c('Mean','Median','UK Average'),
values=c('Mean'='blue','Median'='red','UK Average'='black'))
City_profile
class(filtered_data)
sepal
library(datasets)
data(iris)
iris
City_profile <- ggplot(data=iris,
aes(x=Sepal.Length,
y=Sepal.width))+
geom_smooth(
formula=y~x,
)
City_profile
City_profile <- ggplot(data=iris,
aes(x=Sepal.Length,
y=Sepal.Width))+
geom_smooth(
formula=y~x,
)
City_profile
filtered_data <- filtered_data %>% mutate(IMD=as.numeric(IMD))
City_profile <- ggplot(data=filtered_data,
aes(x=IMD,
y=Total))+
geom_smooth(
formula=y~x,
)
City_profile
#' @keywords heatmap, graph,
#' @export
#' @examples
#' geographic_summary()
#'
city_summary <- function(prawn_path,
shape_path,
targets,
pollutant,
output_path=FALSE,
custom_name=FALSE){
#custom name set to targets for now, might change later
custom_name <- targets
#Reads in the demographic and pollution data
raw_data <- read.csv(file=prawn_path,
row.names=1,
check.names=FALSE) %>% tibble()
#Reads in the shapefiles
raw_shapefile <- st_read(shape_path)
#Takes the subset of the data where the city name matches the targets
filtered_data <- filter(raw_data,TCITY15NM %in% targets)
stitched_shapefile <- inner_join(filtered_data,raw_shapefile, by="LSOA11CD") %>%
mutate(IMD=as.numeric(IMD))
# Graph creation ----------------------------------------------------------
#Create a map showing hpw the population is distrubuted between the deciles in the chosen area,
Decile_distribution <- ggplot()+geom_sf(data=stitched_shapefile,size=0.05)+
aes(fill =IMD,geometry=geometry)+
scale_fill_viridis_d()+
labs(title=paste0(pollutant," emissions by IMD decile"))+
theme(axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks = element_blank())+
guides(fill=guide_legend(ncol=2, byrow=FALSE))
#Create a heatmap for the Nox in the area
Pollutant_distribution <- ggplot()+geom_sf(data=stitched_shapefile,size =0.05)+
aes(fill = Total,geometry=geometry)+
scale_fill_continuous(type ="viridis",direction =-1)+
labs(title=paste0(pollutant," distribution"))+
theme(axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks = element_blank())
#Create a histogram showing the prevalence of each decile in the area
City_histogram <- ggplot(data=stitched_shapefile)+
aes(x=IMD,fill=IMD )+
geom_bar()+
labs(x="IMD decile",
title=paste0(custom_name," IMD histogram"))+
scale_x_discrete(
breaks=c(1:10),
expand = expansion(mult=0,add=0))+
scale_fill_viridis_d()+
guides(fill=guide_legend(ncol=2, byrow=FALSE))
#aoufbihwevbfiywaegrbvibrvkljbverkaljb
#Create a graph showing the relationship between NOx and decile within the chosen area
City_profile <- ggplot(data=filtered_data)+
aes(x=IMD,
y=Total)+
coord_cartesian(xlim = c(1, 10),
ylim= c(0,50))+
scale_x_discrete(
breaks=c(1:10),
expand = expansion(mult=0,add=0))+
scale_y_discrete(
expand = expansion(mult=0,add=0))+
labs(x="IMD decile",
y=paste0(pollutant," emissions"),
title=paste0(custom_name," NOx emission"))+
#Plot the line of best fit for the mean
geom_smooth(method="lm",
formula=y~x,
se=TRUE,
show.legend=FALSE,
aes(color='Mean'))+
#Plot a line passing through the mean at each decile
#Plot the line of best fit for the median
geom_quantile(quantiles=0.5,
aes(color='Median'),
size =1)+
#Plot a line passing through the median at each decile
geom_smooth(data=read.csv(prawn_path)
, aes(
x=IMD,
y=Total,
color='UK Average'),
method="lm",
formula=y~x,
se=FALSE,
show.legend = FALSE)+
#An extra line showing the UK average for comparison purposes
geom_line(data=read.csv(prawn_path),stat="summary" , aes(
x=IMD,
y=Total,colour='UK Average'),
show.legend = FALSE
)+
scale_colour_manual(name="Line type",
breaks = c('Mean','Median','UK Average'),
values=c('Mean'='blue','Median'='red','UK Average'='black'))
#Creates a cumulative distribution plot showing what fractions of each decile are exposed to less than the amount of NOx on the axis
city_freq <- ggplot(data=stitched_shapefile)+
aes(x=Total,group=IMD,colour=IMD)+
scale_colour_viridis_d(option="turbo")+
stat_ecdf(
)+coord_cartesian(xlim = c(0, 100))+
labs(x= paste0(pollutant," emissions"),
y= paste0("Fraction exposed to at least this much ",pollutant),
title=paste0(" Cumulative distribution  of ",pollutant," emissions"))+
scale_y_continuous(
expand = expansion(mult=0,add=0),
)+
scale_x_discrete(
expand = expansion(mult=0,add=0),
)
city_freq
#Create a pivoted copy of the data so the sources can be graphed as separate variables
long_chunk <- filtered_data %>% tibble() %>% mutate(point_sources=Total-Total_no_points)%>%
pivot_longer(
cols=c("Agricultural","Domestic combustion","Energy production",
"Industrial combustion","Industrial production","Natural",
"Offshore","Other transport and mobile machinery","Road transport","Solvents","Total"
,"Waste treatment and disposal","point_sources"),
names_to = "Emission_source",
values_to = "emissions")
long_chunk$Emission_source <- factor(long_chunk$Emission_source)
long_chunk <- long_chunk %>% mutate(Emission_source=fct_reorder(Emission_source,emissions,mean,.desc=TRUE))
city_sources <- Decile_vs_emission_by_variable(
active_stack = long_chunk,
chosen_decile = IMD,
chosen_grouping = Emission_source,
xaxis = "IMD Decile",
yaxis = "NOx emissions",
title = paste0("Source breakdown for ",targets),
chosen_variable = emissions,
Pollutant = "NOx"
)+
geom_quantile(quantiles=0.5,linetype=2)
city_summary <- ggarrange(Decile_distribution,Pollutant_distribution,City_histogram,City_profile,city_sources,city_freq,nrow=3,ncol=2) %>%
annotate_figure(top=text_grob(paste0("Summary of ",pollutant," exposure in ",custom_name)))
# Archive results ---------------------------------------------------------
if (output_path==TRUE){
if (file.exists(output_path)) {
ggsave(filename=paste0(output_path,"/Nox in ",targets[index]),
plot=last_plot(),
units = "mm",height = 160,width=160,
device="png")
} else {
dir.create(output_path)
ggsave(filename=paste0(output_path,"/Nox in ",targets[index]),
plot=last_plot(),
units = "mm",height = 160,width=160,
device="png")
}
}
}
city_summary(prawn_path = "Outputs/create_prawns_1_0_0_test.csv",
shape_path = "Data/2011_LSOA_shapefile_20m_generalised",
targets = "London",
output_path= "Outputs/geographic_summary1_0_0_test",
pollutant="NOx"
)
#Create a pivoted copy of the data so the sources can be graphed as separate variables
long_chunk <- filtered_data %>% tibble() %>% mutate(point_sources=Total-Total_no_points)%>%
pivot_longer(
cols=c("Agricultural","Domestic combustion","Energy production",
"Industrial combustion","Industrial production","Natural",
"Offshore","Other transport and mobile machinery","Road transport","Solvents","Total"
,"Waste treatment and disposal","point_sources"),
names_to = "Emission_source",
values_to = "emissions")
filtered_data
raw_data
#Reads in the demographic and pollution data
raw_data <- read.csv(file=prawn_path,
row.names=1,
check.names=FALSE) %>% tibble()
raw_data
raw_data$`Domestic combustion`
d <- data.frame(group = c(0,1,0,2,1,3,2,0,1,2), x=c(1.2,2.3,3.2,2.1,1.3,1.5,2.3,0.4,1.3,1.7))
d <- data.frame(group = c(0,1,0,2,1,3,2,0,1,2), x=c(1.2,2.3,3.2,2.1,1.3,1.5,2.3,0.4,1.3,1.7)) %>%
group_by(group)
ggplot(d) + geom_boxplot(group, x))
ggplot(d) + geom_boxplot(group, x)
ggplot(d) + geom_boxplot(x)
ggplot(d) + geom_boxplot(aes(group,x)
ggplot(d) + geom_boxplot(aes(group,x))
ggplot(d) + geom_boxplot(aes(group,x))
ggplot(d) + geom_boxplot(aes(group=group,x))
d <- data.frame(group = c(0,1,0,2,1,3,2,0,1,2), x=c(1.2,2.3,3.2,2.1,1.3,1.5,2.3,0.4,1.3,1.7))
ggplot(d) + geom_boxplot(aes(group=group,x))
ggplot(d) + geom_boxplot(aes(group=group,x))
ggplot(d) + geom_boxplot(aes(x,group=group))
ggplot(d) + geom_boxplot(aes(x,group=group))
